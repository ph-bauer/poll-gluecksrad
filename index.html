<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Play the Game</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:24px; background:#fafafa; }
    .card { max-width: 820px; margin: 0 auto; background:#fff; padding:22px; border:1px solid #e6e6e6; border-radius:18px; box-shadow: 0 4px 14px rgba(0,0,0,.04); }
    h1 { font-size: 22px; margin: 0 0 8px; }
    h2 { font-size: 18px; margin: 18px 0 8px; }
    p { margin: 8px 0 14px; line-height:1.35; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    button { padding: 14px 16px; font-size: 16px; border-radius: 12px; border: 1px solid #cfcfcf; background: #fff; cursor:pointer; }
    button.primary { border-color:#111; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .muted { opacity:.75; font-size: 13px; }
    .divider { height:1px; background:#eee; margin:16px 0; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #ddd; font-size:13px; }
    .center { text-align:center; }
    canvas { width:100%; max-width:520px; height:auto; display:block; margin: 10px auto 6px; }
    .big { font-size: 18px; font-weight: 700; }
    .outcome { padding: 12px 14px; border:1px solid #e9e9e9; border-radius:14px; background:#fcfcfc; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px){ .grid { grid-template-columns: 1.2fr .8fr; align-items:start; } }
  </style>
</head>

<body>
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h1 style="margin:0;">Play the Game</h1>
      <span class="badge" id="scoreBadge">Slices: 0</span>
    </div>

    <!-- STEP 1 -->
    <h2>Step 1) Which approach do you prefer?</h2>
    <p class="muted">Choose one option to continue.</p>

    <div class="row">
      <button id="chooseA" class="primary">
        A) American approach: Contingency fees are generally permitted
      </button>
      <button id="chooseB">
        B) German approach: Contingency fees are generally prohibited
      </button>
    </div>

    <div class="divider"></div>

    <!-- STEP 2A: WHEEL -->
    <div id="step2A" style="display:none;">
      <h2>Step 2) American approach → Spin the wheel</h2>
      <div class="grid">
        <div>
          <canvas id="wheel" width="520" height="520"></canvas>
          <div class="row center" style="justify-content:center;">
            <button id="spin" class="primary">Spin</button>
            <button id="resetA">Back</button>
          </div>
          <p class="muted center" style="margin-top:8px;">
            The wheel outputs either “Hurray… (+4 Slices)” or “Sorry… (+0 Slices)”.
          </p>
        </div>
        <div class="outcome">
          <div class="big">Result</div>
          <p id="resultA" style="margin:10px 0 0;">—</p>
        </div>
      </div>
    </div>

    <!-- STEP 2B: AUTO -->
    <div id="step2B" style="display:none;">
      <h2>Step 2) German approach → Automatic outcome</h2>
      <div class="outcome">
        <p class="big" style="margin:0 0 10px;">You won 2 Slices</p>
        <p class="muted" style="margin:0;">(This is an automatic outcome for option B.)</p>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="backB">Back</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row" style="justify-content:space-between; align-items:center;">
      <p class="muted" style="margin:0;">Tip: You can reset the score if you want a fresh run.</p>
      <button id="clearScore">Reset Slices</button>
    </div>
  </div>

<script>
  /**********************
   * CONFIG (optional)
   **********************/
  // Probability that the client "wins" on the wheel (0..1)
  // Example: 0.5 = 50/50, 0.7 = 70% win chance
  const WIN_PROBABILITY = 0.5;

  const OUTCOMES = [
    { label: "Hurray, your client won", slices: 4 },
    { label: "Sorry, your client lost", slices: 0 },
  ];

  /**********************
   * STATE
   **********************/
  const scoreKey = "pollWheelSlicesScore";
  let score = Number(localStorage.getItem(scoreKey) || "0");

  function setScore(newScore){
    score = newScore;
    localStorage.setItem(scoreKey, String(score));
    scoreBadge.textContent = `Slices: ${score}`;
  }

  /**********************
   * UI ELEMENTS
   **********************/
  const chooseA = document.getElementById("chooseA");
  const chooseB = document.getElementById("chooseB");
  const step2A = document.getElementById("step2A");
  const step2B = document.getElementById("step2B");
  const scoreBadge = document.getElementById("scoreBadge");
  const clearScore = document.getElementById("clearScore");

  const spinBtn = document.getElementById("spin");
  const resetA = document.getElementById("resetA");
  const resultA = document.getElementById("resultA");

  const backB = document.getElementById("backB");

  setScore(score);

  function showNone(){
    step2A.style.display = "none";
    step2B.style.display = "none";
    // re-enable choices
    chooseA.disabled = false;
    chooseB.disabled = false;
  }

  function showA(){
    showNone();
    step2A.style.display = "block";
    chooseA.disabled = true;
    chooseB.disabled = true;
    resultA.textContent = "—";
    drawWheel(); // ensure fresh render
  }

  function showB(){
    showNone();
    step2B.style.display = "block";
    chooseA.disabled = true;
    chooseB.disabled = true;

    // automatic outcome: +2 slices
    setScore(score + 2);
  }

  chooseA.addEventListener("click", showA);
  chooseB.addEventListener("click", showB);

  resetA.addEventListener("click", showNone);
  backB.addEventListener("click", showNone);

  clearScore.addEventListener("click", () => setScore(0));

  /**********************
   * WHEEL RENDER + SPIN
   **********************/
  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");

  let angle = 0;
  let spinning = false;

  function drawWheel(){
    const W = canvas.width, H = canvas.height;
    const cx = W/2, cy = H/2;
    const r = Math.min(W,H)/2 - 12;

    ctx.clearRect(0,0,W,H);

    const step = (Math.PI*2)/OUTCOMES.length;

    for (let i=0; i<OUTCOMES.length; i++){
      const a0 = angle + i*step;
      const a1 = a0 + step;

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,a0,a1);
      ctx.closePath();

      // simple alternating fills
      ctx.fillStyle = (i%2===0) ? "#f3f3f3" : "#ffffff";
      ctx.fill();

      ctx.strokeStyle = "#111";
      ctx.stroke();

      // text
      ctx.save();
      ctx.translate(cx,cy);
      ctx.rotate(a0 + step/2);
      ctx.textAlign = "right";
      ctx.fillStyle = "#111";
      ctx.font = "16px system-ui";
      ctx.fillText(`${OUTCOMES[i].label} (+${OUTCOMES[i].slices})`, r - 16, 6);
      ctx.restore();
    }

    // pointer at top
    ctx.beginPath();
    ctx.moveTo(cx, cy - r - 2);
    ctx.lineTo(cx - 12, cy - r - 26);
    ctx.lineTo(cx + 12, cy - r - 26);
    ctx.closePath();
    ctx.fillStyle = "#111";
    ctx.fill();
  }

  function outcomeFromAngle(){
    const step = (Math.PI*2)/OUTCOMES.length;
    const pointerAngle = -Math.PI/2; // top
    let a = (pointerAngle - angle) % (Math.PI*2);
    if (a < 0) a += Math.PI*2;
    const idx = Math.floor(a / step);
    return OUTCOMES[idx];
  }

  function pickTargetAngleForOutcome(outcomeIndex){
    // Pick a random angle that ends with the pointer landing inside the chosen segment.
    const step = (Math.PI*2)/OUTCOMES.length;
    const pointerAngle = -Math.PI/2;

    // We want: outcomeIndex segment under pointer.
    // That means angle such that (pointerAngle - angle) falls into [idx*step, (idx+1)*step)
    // So angle should be pointerAngle - [idx*step + epsilon]
    const epsilon = 0.2 * step + Math.random() * 0.6 * step; // keep away from borders
    const targetAngleNormalized = pointerAngle - (outcomeIndex * step + epsilon);

    return targetAngleNormalized;
  }

  spinBtn.addEventListener("click", () => {
    if (spinning) return;
    spinning = true;
    spinBtn.disabled = true;
    resultA.textContent = "Spinning…";

    // Decide outcome by probability (win vs lose)
    const win = Math.random() < WIN_PROBABILITY;
    const chosenIndex = win ? 0 : 1;

    // Calculate spin animation target
    const durationMs = 2200 + Math.random()*900;
    const start = performance.now();
    const startAngle = angle;

    const extraSpins = 7 + Math.random()*6; // number of full turns for dramatic effect
    const targetNormalized = pickTargetAngleForOutcome(chosenIndex);

    // Make target relative to current angle (add full spins)
    const target = startAngle + extraSpins * Math.PI*2 + (targetNormalized - (startAngle % (Math.PI*2)));

    function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

    function tick(now){
      const t = Math.min(1, (now - start) / durationMs);
      angle = startAngle + (target - startAngle) * easeOutCubic(t);
      drawWheel();

      if (t < 1){
        requestAnimationFrame(tick);
      } else {
        spinning = false;
        spinBtn.disabled = false;

        const out = outcomeFromAngle();
        resultA.textContent = `${out.label} → You got ${out.slices} Slices.`;
        setScore(score + out.slices);
      }
    }

    requestAnimationFrame(tick);
  });

  // initial render
  drawWheel();
</script>
</body>
</html>
