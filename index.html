<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Play the Game: Pizza & Fees</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:24px; background:#fafafa; }
    .card { max-width: 820px; margin: 0 auto; background:#fff; padding:22px; border:1px solid #e6e6e6; border-radius:18px; box-shadow: 0 4px 14px rgba(0,0,0,.04); }
    h1 { font-size: 22px; margin: 0 0 8px; }
    h2 { font-size: 18px; margin: 18px 0 8px; }
    p { margin: 8px 0 14px; line-height:1.35; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    button { padding: 14px 16px; font-size: 16px; border-radius: 12px; border: 1px solid #cfcfcf; background: #fff; cursor:pointer; }
    button.primary { border-color:#111; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .muted { opacity:.75; font-size: 13px; }
    .divider { height:1px; background:#eee; margin:16px 0; }
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #ddd; font-size:13px; }
    .center { text-align:center; }
    canvas { width:100%; max-width:520px; height:auto; display:block; margin: 10px auto 6px; }
    .big { font-size: 18px; font-weight: 700; }
    .outcome { padding: 12px 14px; border:1px solid #e9e9e9; border-radius:14px; background:#fcfcfc; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 720px){ .grid { grid-template-columns: 1.2fr .8fr; align-items:start; } }
    .lockscreen { max-width:820px; margin:0 auto; padding:24px; }
    .lockcard { border:1px solid #e6e6e6; border-radius:18px; padding:22px; background:#fff; box-shadow: 0 4px 14px rgba(0,0,0,.04); }
    .pizza { font-size: 28px; letter-spacing: 2px; }
  </style>
</head>

<body>
  <div class="card" id="app">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h1 style="margin:0;">Play the Game: Pizza as a Metaphor</h1>
      <span class="badge" id="scoreBadge">Slices: 0</span>
    </div>
    <p class="muted" style="margin-top:6px;">
      One run per participant. (Presenter reset available via <code>?host=1</code>)
    </p>

    <!-- STEP 1 -->
    <h2>Step 1) Which approach do you prefer?</h2>
    <p class="muted">Play the Game: Which approach do you prefer?</p>

    <div class="row">
      <button id="chooseA" class="primary">
        A) American approach: Contingency fees are generally permitted
      </button>
      <button id="chooseB">
        B) German approach: Contingency fees are generally prohibited
      </button>
    </div>

    <div class="divider"></div>

    <!-- STEP 2A: WHEEL -->
    <div id="step2A" style="display:none;">
      <h2>Step 2) American approach ‚Üí Spin the pizza wheel</h2>
      <div class="grid">
        <div>
          <canvas id="wheel" width="520" height="520"></canvas>
          <div class="row center" style="justify-content:center;">
            <button id="spin" class="primary">Spin</button>
            <button id="backA">Back</button>
          </div>
          <p class="muted center" style="margin-top:8px;">
            The wheel outputs either a full pizza win (+4 slices) or no pizza (+0 slices).
          </p>
        </div>
        <div class="outcome">
          <div class="big">Outcome</div>
          <p id="resultA" style="margin:10px 0 0;">‚Äî</p>
          <div id="pizzaA" class="pizza center" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <!-- STEP 2B: AUTO -->
    <div id="step2B" style="display:none;">
      <h2>Step 2) German approach ‚Üí Automatic outcome</h2>
      <div class="outcome">
        <p class="big" style="margin:0 0 10px;">üçïüçï You won 2 Slices</p>
        <p style="margin:0;">Predictable outcome: contingency fees generally prohibited.</p>
        <p class="muted" style="margin:8px 0 0;">Please keep this screen open and show it to the presenter.</p>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="backB">Back</button>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row" style="justify-content:space-between; align-items:center;">
      <p class="muted" style="margin:0;">Presenter controls (hidden for participants).</p>
      <button id="hostReset">Host reset</button>
    </div>
  </div>

<script>
  /**********************
   * CONFIG
   **********************/
  // Probability that the "client wins" under A (0..1)
  const WIN_PROBABILITY = 0.5;

  // Local lock: one run per device/browser (no backend)
  const RUN_LOCK_KEY = "pizzaFeeGame_runCompleted_v1";
  const SCORE_KEY    = "pizzaFeeGame_slicesScore_v1";

  // Host mode allows reset/unlock: add ?host=1 to URL
  const isHost = new URLSearchParams(location.search).get("host") === "1";

  const OUTCOMES = [
    { label: "üçïüçïüçïüçï Hurray, your client won the whole pizza!", slices: 4, pizzas: "üçïüçïüçïüçï" },
    { label: "üôÉ Sorry, your client lost ‚Äî no pizza tonight.", slices: 0, pizzas: "" },
  ];

  /**********************
   * LOCK SCREEN (one run)
   **********************/
  if (localStorage.getItem(RUN_LOCK_KEY) === "1" && !isHost) {
    document.body.innerHTML = `
      <div class="lockscreen">
        <div class="lockcard">
          <h1 style="margin:0 0 8px;">Thanks for playing! üçï</h1>
          <p style="margin:0 0 12px; line-height:1.35;">
            This game is limited to <b>one run per participant</b>.
          </p>
          <p style="margin:0; opacity:.75;">
            If you think this is a mistake, please ask the presenter.
          </p>
        </div>
      </div>
    `;
    // Stop execution early
    throw new Error("Run is locked (participant mode).");
  }

  /**********************
   * STATE
   **********************/
  let score = Number(localStorage.getItem(SCORE_KEY) || "0");

  function setScore(newScore){
    score = newScore;
    localStorage.setItem(SCORE_KEY, String(score));
    scoreBadge.textContent = `Slices: ${score}`;
  }

  function lockRun(){
    localStorage.setItem(RUN_LOCK_KEY, "1");
  }

  function unlockRun(){
    localStorage.removeItem(RUN_LOCK_KEY);
  }

  /**********************
   * UI ELEMENTS
   **********************/
  const chooseA = document.getElementById("chooseA");
  const chooseB = document.getElementById("chooseB");
  const step2A  = document.getElementById("step2A");
  const step2B  = document.getElementById("step2B");
  const scoreBadge = document.getElementById("scoreBadge");

  const spinBtn = document.getElementById("spin");
  const backA   = document.getElementById("backA");
  const resultA = document.getElementById("resultA");
  const pizzaA  = document.getElementById("pizzaA");

  const backB   = document.getElementById("backB");

  const hostResetBtn = document.getElementById("hostReset");

  setScore(score);

  // Hide host controls from participants
  if (!isHost) {
    hostResetBtn.style.display = "none";
  }

  function showNone(){
    step2A.style.display = "none";
    step2B.style.display = "none";
    chooseA.disabled = false;
    chooseB.disabled = false;
  }

  function showA(){
    showNone();
    step2A.style.display = "block";
    chooseA.disabled = true;
    chooseB.disabled = true;
    resultA.textContent = "‚Äî";
    pizzaA.textContent = "";
    drawWheel();
  }

  function showB(){
    showNone();
    step2B.style.display = "block";
    chooseA.disabled = true;
    chooseB.disabled = true;

    // Automatic outcome for B
    setScore(score + 2);

    // Lock one run
    lockRun();
  }

  chooseA.addEventListener("click", showA);
  chooseB.addEventListener("click", showB);

  backA.addEventListener("click", showNone);
  backB.addEventListener("click", showNone);

  // Host reset clears score + lock
  hostResetBtn.addEventListener("click", () => {
    if (!isHost) return;
    setScore(0);
    unlockRun();
    alert("Host reset done: score and run lock cleared.");
  });

  /**********************
   * WHEEL RENDER + SPIN
   **********************/
  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");

  let angle = 0;
  let spinning = false;

  function drawWheel(){
    const W = canvas.width, H = canvas.height;
    const cx = W/2, cy = H/2;
    const r = Math.min(W,H)/2 - 12;

    ctx.clearRect(0,0,W,H);

    const step = (Math.PI*2)/OUTCOMES.length;

    for (let i=0; i<OUTCOMES.length; i++){
      const a0 = angle + i*step;
      const a1 = a0 + step;

      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,a0,a1);
      ctx.closePath();

      ctx.fillStyle = (i%2===0) ? "#f3f3f3" : "#ffffff";
      ctx.fill();

      ctx.strokeStyle = "#111";
      ctx.stroke();

      ctx.save();
      ctx.translate(cx,cy);
      ctx.rotate(a0 + step/2);
      ctx.textAlign = "right";
      ctx.fillStyle = "#111";
      ctx.font = "16px system-ui";
      ctx.fillText(`${OUTCOMES[i].label} (+${OUTCOMES[i].slices})`, r - 16, 6);
      ctx.restore();
    }

    // pointer
    ctx.beginPath();
    ctx.moveTo(cx, cy - r - 2);
    ctx.lineTo(cx - 12, cy - r - 26);
    ctx.lineTo(cx + 12, cy - r - 26);
    ctx.closePath();
    ctx.fillStyle = "#111";
    ctx.fill();
  }

  function outcomeFromAngle(){
    const step = (Math.PI*2)/OUTCOMES.length;
    const pointerAngle = -Math.PI/2;
    let a = (pointerAngle - angle) % (Math.PI*2);
    if (a < 0) a += Math.PI*2;
    const idx = Math.floor(a / step);
    return OUTCOMES[idx];
  }

  function pickTargetAngleForOutcome(outcomeIndex){
    const step = (Math.PI*2)/OUTCOMES.length;
    const pointerAngle = -Math.PI/2;
    const epsilon = 0.2 * step + Math.random() * 0.6 * step;
    return pointerAngle - (outcomeIndex * step + epsilon);
  }

  spinBtn.addEventListener("click", () => {
    if (spinning) return;
    spinning = true;
    spinBtn.disabled = true;
    resultA.textContent = "Spinning‚Ä¶";
    pizzaA.textContent = "";

    // Decide outcome by probability
    const win = Math.random() < WIN_PROBABILITY;
    const chosenIndex = win ? 0 : 1;

    const durationMs = 2200 + Math.random()*900;
    const start = performance.now();
    const startAngle = angle;

    const extraSpins = 7 + Math.random()*6;
    const targetNormalized = pickTargetAngleForOutcome(chosenIndex);

    const target = startAngle
      + extraSpins * Math.PI*2
      + (targetNormalized - (startAngle % (Math.PI*2)));

    function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

    function tick(now){
      const t = Math.min(1, (now - start) / durationMs);
      angle = startAngle + (target - startAngle) * easeOutCubic(t);
      drawWheel();

      if (t < 1){
        requestAnimationFrame(tick);
      } else {
        spinning = false;
        spinBtn.disabled = false;

        const out = outcomeFromAngle();
        resultA.textContent = `${out.label} ‚Üí You got ${out.slices} Slices.`;
        pizzaA.textContent = out.pizzas;
        setScore(score + out.slices);

        // Lock one run after the wheel outcome
        lockRun();
      }
    }

    requestAnimationFrame(tick);
  });

  // initial render
  drawWheel();
</script>
</body>
</html>

